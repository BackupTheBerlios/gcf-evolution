#!/bin/sh

usage () {
	echo "Configure für evolution

Copyright (C) 2003 Bodo Thiesen

Syntax: configure [argumente]

Zulässige Argumente:

	--prefix dir		Basisinstallationsverzeichnis.
				Standard = ${prefix}
	--exeprefix dir		Installationsverzeichnis für Binaries
				Standard = ${exeprefix}
	
	--set-owner bool	Setzen des Besitzers der Dateien via chown?
				Standard = ${SETOWN}
	--set-mode bool		Setzen der Dateirechte der Dateien via chmod?
				Standard = ${SETMOD}
	
	--set-worm-user user	Unprivilegierter Benutzer für die
				Wurm-Zivilisation.
				Standard = ${wormuser}
	--set-worm-group group	Unprivilegierte Gruppe für die 
				Wurm-Zivilisation.
				Standard = ${wormgroup}
	
	--set-root-user user	Privilegierter Benutzer für die Administrativen 
				Programme.
				Standard = ${rootuser}
	--set-root-group group	Privilegierte Gruppe für die Administrativen 
				Programme.
				Standard = ${rootgroup}
	
	--eww-max-files num	Setzt Maximalzahl der Dateien, die sich eww 
				merken kann.
				Standard = ${EWW_MAX_FILES}
	--eww-del-delay num	Wartezeit zwischen dem merken der Dateien, und 
				dem Löschen.
				Standard = ${EWW_DEL_DELAY}
	
	--wcpy-max-sleep num	Maximale Wartezeit (in ms) zwischen Aufruf 
				durch den Wurm, und dem Beginn der
				Kopieraktion.
				Standard = ${WCPY_MAX_SLEEP}
	--wcpy-byte-drop num	Durchschnittlich jedes num-te Byte 
				unterschlagen.
				Standard = ${WCPY_BYTE_DROP}
	--wcpy-byte-add num	Durchschnittlich nach jedem num-ten Byte ein 
				Byte hinzufügen.
				Standard = ${WCPY_BYTE_ADD}
	--wcpy-byte-chg num	Durchschnittlich jedes num-te Byte verändern.
				Standard = ${WCPY_BYTE_CHG}
	
	--worm-max-num-procs x	Zu prüfendes rlimit beim Start des Wurms. Der 
				Wurm beendet sich sofort, falls das rlimit 
				höher ist, als dieser Wert.
				Standard = ${WORM_MAX_NUM_PROCS}
	
	--bash-pid-file file	Dateiname der pidfile, in der eine PID 
				eingetragen werden kann, die wurmkill niemals 
				killt.
				Standard = ${BASH_PID_FILE}
"
}

#
# Standardwerte setzen
#

prefix=/usr/local

SETOWN=yes
SETMOD=yes

wormuser=evouser
wormgroup=nogroup

rootuser=root
rootgroup=root

EWW_MAX_FILES=512
EWW_DEL_DELAY=300

WCPY_MAX_SLEEP=20000000
WCPY_BYTE_DROP=30000
WCPY_BYTE_ADD=30000
WCPY_BYTE_CHG=20000

WORM_MAX_NUM_PROCS=500

BASH_PID_FILE="/tmp/evolution.bash.pid"

#
# Kommandozeile auswerten
#

while ! test $# = 0; do
	case "$1" in
		--prefix)
			prefix=$2; shift; shift; ;;
		
		--exeprefix)
			exeprefix=$2; shift; shift; ;;
		
		--set-owner)
			SETOWN=$2; shift; shift; ;;
		
		--set-mode)
			SETMOD=$2; shift; shift; ;;
		
		--set-worm-user)
			wormuser=$2; shift; shift; ;;
		
		--set-worm-group)
			wormgroup=$2; shift; shift; ;;
		
		--set-root-user)
			rootuser=$2; shift; shift; ;;
		
		--set-root-group)
			rootgroup=$2; shift; shift; ;;
		
		--eww-max-files)
			EWW_MAX_FILES=$2; shift; shift; ;;
		
		--eww-del-delay)
			EWW_DEL_DELAY=$2; shift; shift; ;;
		
		--wcpy-max-sleep)
			WCPY_MAX_SLEEP=$2; shift; shift; ;;
		
		--wcpy-byte-drop)
			WCPY_BYTE_DROP=$2; shift; shift; ;;
		
		--wcpy-byte-add)
			WCPY_BYTE_ADD=$2; shift; shift; ;;
		
		--wcpy-byte-chg)
			WCPY_BYTE_CHG=$2; shift; shift; ;;
		
		--worm-max-num-procs)
			WORM_MAX_NUM_PROCS=$2; shift; shift; ;;
	
		--bash-pid-file)
			BASH_PID_FILE=$2; shift; shift; ;;
		
		-help|-HELP|--help|--HELP|--h|--H|-h|-H|-?|--?)
			usage
			exit 1
			;;
		
		*)
			echo "Ungültiges Argument übergeben: $1"
			echo ""
			usage
			exit 2
			;;
	esac
done

#
# Konstruierte Standardwerte setzen, sofern nicht vom Benutzer überschrieben.
#

test -z $exeprefix && exeprefix=${prefix}/bin

#
# Und ein paar Systemtests machen ...
#

echo -en "Checking if OS is Linux ... "

if (grep --silent 'Linux' /proc/sys/kernel/ostype); then
	echo "yes"
	LDFLAGS=-lpthread
else
	echo "no"
	LDFLAGS=-pthread
fi

echo -en "Checking wether gcc works ... "
echo >configure.c <<EOF
int main();
EOF
if ! gcc -c -o configure.o configure.c; then
	echo "no"
	echo "Failed to find a working C compiler"
	exit 2
fi
echo "yes"
CC=gcc

echo -en "Checking wether g++ works ... "
echo >configure.cpp <<EOF
int main();
EOF
if ! gcc -c -o configure.o configure.cpp; then
	echo "no"
	echo "Failed to find a working C++ compiler"
	exit 2
fi
echo "yes"
CXX=g++

#
# So, das war's schon, jetzt können wir die Makefile.Config anlegen
#
# Wir legen mal von Anfang an auch eine config.h an, die zukünftig dann von 
# allen Quellen eingebunden werden soll.
#

for i in Makefile.Config src/config.h; do
	rm -f $i
	echo >$i '#if 0
ifdef HOPEFULLY_UNDEFINED_SYMBOL

/*** WARNING *** WARNING *** WARNING *** WARNING *** WARNING ***
 ***                                                         ***
 *** Don'\''t fuck this file, as it is automatically generated. ***
 *** Run configure to change settings instead.               ***
 ***                                                         ***
 *** WARNING *** WARNING *** WARNING *** WARNING *** WARNING ***/

endif
#endif
'
done

echo "LDFLAGS += $LDFLAGS" >> Makefile.Config
echo "" >> Makefile.Config
echo "EXEPREFIX = $exeprefix" >> Makefile.Config

echo "" >> Makefile.Config
if test $SETOWN == yes; then
	echo "CHOWN = chown" >> Makefile.Config
else
	echo "CHOWN = true" >> Makefile.Config
fi
if test $SETMOD == yes; then
	echo "CHMOD = chmod" >> Makefile.Config
else
	echo "CHMOD = true" >> Makefile.Config
fi
echo "CC = $CC" >> Makefile.Config
echo "CXX = $CXX" >> Makefile.Config

echo "" >> Makefile.Config
echo "WORMUSER  = $wormuser"  >> Makefile.Config
echo "WORMGROUP = $wormgroup" >> Makefile.Config
echo "ROOTUSER  = $rootuser"  >> Makefile.Config
echo "ROOTGROUP = $rootgroup" >> Makefile.Config

echo "#define EWW_MAX_FILES $EWW_MAX_FILES" >> src/config.h
echo "#define EWW_DEL_DELAY $EWW_DEL_DELAY" >> src/config.h
echo "#define WCPY_MAX_SLEEP $WCPY_MAX_SLEEP" >> src/config.h
echo "#define WCPY_BYTE_DROP $WCPY_BYTE_DROP" >> src/config.h
echo "#define WCPY_BYTE_ADD $WCPY_BYTE_ADD" >> src/config.h
echo "#define WCPY_BYTE_CHG $WCPY_BYTE_CHG" >> src/config.h
echo "#define WORM_MAX_NUM_PROCS $WORM_MAX_NUM_PROCS" >> src/config.h
echo "#define BASH_PID_FILE \"$BASH_PID_FILE\"" >> src/config.h

rm configure.* # DON'T REMOVE THE DOT!

echo ""
echo "Now type 'make' and pray ;-)";
